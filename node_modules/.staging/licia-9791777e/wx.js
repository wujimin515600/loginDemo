const each = require('./each');
const arrToMap = require('./arrToMap');
const startWith = require('./startWith');
const endWith = require('./endWith');

const noPromiseMethods = arrToMap([
    'stopRecord',
    'getRecorderManager',
    'pauseVoice',
    'stopVoice',
    'pauseBackgroundAudio',
    'stopBackgroundAudio',
    'getBackgroundAudioManager',
    'createAudioContext',
    'createInnerAudioContext',
    'createVideoContext',
    'createCameraContext',

    'createMapContext',

    'canIUse',
    'startAccelerometer',
    'stopAccelerometer',
    'startCompass',
    'stopCompass',
    'onBLECharacteristicValueChange',
    'onBLEConnectionStateChange',

    'hideToast',
    'hideLoading',
    'showNavigationBarLoading',
    'hideNavigationBarLoading',
    'navigateBack',
    'createAnimation',
    'pageScrollTo',
    'createSelectorQuery',
    'createCanvasContext',
    'createContext',
    'drawCanvas',
    'hideKeyboard',
    'stopPullDownRefresh',

    'arrayBufferToBase64',
    'base64ToArrayBuffer'
]);

function needToPromisify(name) {
    return (
        !noPromiseMethods[name] &&
        !startWith(name, 'on') &&
        !endWith(name, 'Sync')
    );
}

each(wx, (fn, name) => {
    if (!needToPromisify(name)) return;

    exports[name] = function(obj) {
        return new Promise((resolve, reject) => {
            fn.call(wx, {
                ...obj,
                success(res) {
                    resolve(res);
                },
                fail(res) {
                    reject(res);
                }
            });
        });
    };
});

module.exports = exports;
